import os
import google.generativeai as genai
from flask import Flask, render_template, request, jsonify

app = Flask(__name__)

# Configure Gemini API
genai.configure(api_key=os.environ.get("GEMINI_API_KEY", ""))

# System prompt - the user never sees this
SYSTEM_PROMPT = """أنت مستشار قانوني متخصص في نظام العمل السعودي.

القواعد:
1. أجب فقط عن المسائل المتعلقة بنظام العمل السعودي.
2. إذا كان السؤال خارج نطاق نظام العمل، اعتذر بلطف ووضح أن تخصصك هو نظام العمل السعودي فقط.
3. اشرح بأسلوب بسيط وسهل يفهمه أي شخص غير متخصص.
4. اذكر رقم المادة من نظام العمل السعودي إن أمكن.
5. وضح حقوق العامل وصاحب العمل بشكل متوازن.
6. أضف في النهاية تنبيه: "هذا توضيح عام وليس استشارة قانونية رسمية. للحالات الخاصة راجع محامي أو وزارة الموارد البشرية."
7. رتب إجابتك بشكل واضح باستخدام عناوين ونقاط.
8. لا تتجاوز 300 كلمة في الرد.

مشكلة المستخدم:
"""

# Demo responses for when API quota is exceeded
DEMO_RESPONSES = [
    {
        "keywords": ["إجازة", "إجازات", "يوم إجازة", "عطلة", "عطل"],
        "answer": """**الإجازات في نظام العمل السعودي**

حسب نظام العمل السعودي، لك الحقوق التالية:

**1. الإجازة السنوية (المادة 109):**
- 21 يوماً إذا كانت خدمتك أقل من 5 سنوات
- 30 يوماً إذا أكملت 5 سنوات فأكثر
- الإجازة مدفوعة الأجر بالكامل

**2. إجازات أخرى مهمة:**
- إجازة الزواج: 5 أيام
- إجازة وفاة الزوج/أحد الأصول/الفروع: 5 أيام
- إجازة ولادة مولود: 3 أيام
- إجازة الحج: 10-15 يوماً (مرة واحدة خلال الخدمة)

**3. حقوقك:**
- لا يجوز لصاحب العمل منعك من الإجازة السنوية
- يمكن تأجيلها بالاتفاق لكن لا تسقط
- تُحتسب أيام الأعياد والعطل الرسمية من ضمن الإجازة إذا وقعت خلالها

⚠️ هذا توضيح عام وليس استشارة قانونية رسمية. للحالات الخاصة راجع محامي أو وزارة الموارد البشرية."""
    },
    {
        "keywords": ["راتب", "رواتب", "ما دفعوا", "خصم", "تأخير راتب", "خصم راتب"],
        "answer": """**حقوقك في الراتب حسب نظام العمل السعودي**

**1. موعد صرف الراتب (المادة 90):**
- يجب دفع الأجر في موعده المحدد بالعقد
- العمال باليومية يُدفع لهم مرة كل أسبوع على الأقل
- العمال بالشهر يُدفع لهم مرة في الشهر

**2. التأخير في الراتب (المادة 94):**
- إذا تأخر الراتب أكثر من شهرين، يحق لك التقدم لمكتب العمل
- يحق لك ترك العمل مع الاحتفاظ بجميع حقوقك إذا لم يُدفع الراتب

**3. الخصم من الراتب (المادة 91-93):**
- لا يجوز خصم أكثر من نصف الراتب
- لا يجوز الخصم إلا بسند تنفيذي أو موافقة خطية
- أي خصم بدون وجه حق يمكنك الاعتراض عليه

**4. ماذا تفعل؟**
- قدم شكوى عبر منصة "ودّي" لمكتب العمل
- أو اتصل على الرقم الموحد: 19911

⚠️ هذا توضيح عام وليس استشارة قانونية رسمية. للحالات الخاصة راجع محامي أو وزارة الموارد البشرية."""
    },
    {
        "keywords": ["فصل", "طرد", "طردوني", "فصلوني", "إنهاء", "فسخ العقد", "بدون سبب"],
        "answer": """**الفصل من العمل في نظام العمل السعودي**

**1. الفصل التعسفي (المادة 77):**
- إذا فُصلت بدون سبب مشروع، يحق لك تعويض يشمل:
  - أجر 15 يوماً عن كل سنة خدمة (عقد غير محدد المدة)
  - أجر المدة المتبقية من العقد (عقد محدد المدة)
  - بحد أدنى أجر شهرين

**2. الأسباب المشروعة للفصل (المادة 80):**
يحق لصاحب العمل فصلك بدون تعويض فقط في حالات محددة مثل:
- الاعتداء على صاحب العمل
- عدم أداء الالتزامات الجوهرية
- التغيب أكثر من 30 يوماً أو 15 يوماً متتالية بدون عذر
- الغش وقت التعيين

**3. فترة الإشعار (المادة 75):**
- يجب إشعارك قبل الفصل بـ 60 يوماً على الأقل (عقد غير محدد)
- إذا لم يتم الإشعار، تستحق تعويض مدة الإشعار

**4. ماذا تفعل؟**
- قدم دعوى عبر منصة "ودّي" خلال 12 شهراً من الفصل
- احتفظ بأي مستندات تثبت عملك

⚠️ هذا توضيح عام وليس استشارة قانونية رسمية. للحالات الخاصة راجع محامي أو وزارة الموارد البشرية."""
    },
    {
        "keywords": ["تجربة", "فترة التجربة", "فترة تجربة"],
        "answer": """**فترة التجربة في نظام العمل السعودي**

**1. مدة فترة التجربة (المادة 53):**
- الأصل: لا تزيد عن 90 يوماً (3 أشهر)
- يمكن تمديدها باتفاق مكتوب بين الطرفين إلى 180 يوماً (6 أشهر)
- لا تشمل إجازة عيد الفطر والأضحى والإجازات المرضية

**2. حقوقك خلال فترة التجربة:**
- راتبك كامل حسب العقد
- جميع حقوق العامل العادي (تأمينات، رعاية صحية)
- لا يجوز وضعك تحت التجربة مرتين عند نفس صاحب العمل

**3. إنهاء العقد خلال التجربة (المادة 54):**
- يحق لأي طرف إنهاء العقد خلال فترة التجربة
- بدون تعويض أو مكافأة نهاية خدمة
- ما لم ينص العقد على خلاف ذلك

**4. ملاحظة مهمة:**
- يجب أن تكون فترة التجربة مكتوبة في العقد
- إذا لم تُذكر في العقد، يُعتبر العامل مُثبتاً من أول يوم

⚠️ هذا توضيح عام وليس استشارة قانونية رسمية. للحالات الخاصة راجع محامي أو وزارة الموارد البشرية."""
    },
    {
        "keywords": ["استقالة", "أبي أستقيل", "ترك العمل", "أبغى أطلع"],
        "answer": """**الاستقالة في نظام العمل السعودي**

**1. تقديم الاستقالة (المادة 75):**
- عقد غير محدد المدة: يجب إشعار صاحب العمل قبل 60 يوماً (إذا كان الراتب شهري) أو 30 يوماً (لغير ذلك)
- عقد محدد المدة: الأصل الالتزام بمدة العقد

**2. مكافأة نهاية الخدمة (المادة 84-86):**
- أجر نصف شهر عن كل سنة من الخمس سنوات الأولى
- أجر شهر كامل عن كل سنة بعد ذلك
- إذا كانت الاستقالة: تستحق ثلث المكافأة (2-5 سنوات) أو ثلثيها (5-10 سنوات) أو كاملة (أكثر من 10 سنوات)

**3. حقوقك عند الاستقالة:**
- شهادة خبرة (المادة 64)
- بدل إجازات لم تستخدمها
- تصفية مستحقاتك خلال أسبوع

**4. نصيحة:**
- قدم الاستقالة كتابياً
- احتفظ بنسخة من الاستقالة موقعة ومؤرخة

⚠️ هذا توضيح عام وليس استشارة قانونية رسمية. للحالات الخاصة راجع محامي أو وزارة الموارد البشرية."""
    },
    {
        "keywords": ["نهاية الخدمة", "مكافأة", "مكافأة نهاية"],
        "answer": """**مكافأة نهاية الخدمة في نظام العمل السعودي**

**1. طريقة الحساب (المادة 84):**
- أجر نصف شهر عن كل سنة من السنوات الخمس الأولى
- أجر شهر كامل عن كل سنة بعد الخمس سنوات
- تُحسب على آخر أجر كان يتقاضاه العامل

**2. حالات الاستحقاق الكامل:**
- إنهاء العقد من صاحب العمل
- انتهاء مدة العقد
- استقالة بعد 10 سنوات فأكثر
- ترك العمل بسبب قوة قاهرة

**3. حالات الاستحقاق الجزئي (استقالة):**
- ثلث المكافأة: خدمة من سنتين إلى 5 سنوات
- ثلثا المكافأة: خدمة من 5 إلى 10 سنوات

**4. مثال عملي:**
عامل خدم 8 سنوات وراتبه 10,000 ريال:
- أول 5 سنوات: 5,000 × 5 = 25,000 ريال
- آخر 3 سنوات: 10,000 × 3 = 30,000 ريال
- الإجمالي: 55,000 ريال

⚠️ هذا توضيح عام وليس استشارة قانونية رسمية. للحالات الخاصة راجع محامي أو وزارة الموارد البشرية."""
    },
]

# Default fallback response
DEFAULT_DEMO_RESPONSE = """**مستشارك العمالي**

شكراً لسؤالك! أنا هنا لمساعدتك في كل ما يتعلق بنظام العمل السعودي.

**يمكنني مساعدتك في مواضيع مثل:**
- الإجازات وحقوقك فيها
- الرواتب والخصومات
- الفصل التعسفي والتعويضات
- فترة التجربة وشروطها
- الاستقالة ومكافأة نهاية الخدمة
- ساعات العمل والعمل الإضافي

**جرب تسأل سؤال محدد مثل:**
- "كم يوم إجازة أستحق في السنة؟"
- "طردوني من الشغل بدون سبب"
- "كم مدة فترة التجربة؟"

⚠️ هذا توضيح عام وليس استشارة قانونية رسمية. للحالات الخاصة راجع محامي أو وزارة الموارد البشرية."""


def get_demo_response(question):
    """Find the best matching demo response based on keywords."""
    question_lower = question.strip()
    best_match = None
    best_score = 0

    for entry in DEMO_RESPONSES:
        score = sum(1 for kw in entry["keywords"] if kw in question_lower)
        if score > best_score:
            best_score = score
            best_match = entry["answer"]

    return best_match if best_match else DEFAULT_DEMO_RESPONSE


@app.route("/")
def index():
    return render_template("index.html")


@app.route("/ask", methods=["POST"])
def ask():
    user_question = request.json.get("question", "").strip()

    if not user_question:
        return jsonify({"error": "الرجاء كتابة مشكلتك أولاً"}), 400

    try:
        model = genai.GenerativeModel("gemini-2.0-flash")
        response = model.generate_content(SYSTEM_PROMPT + user_question)
        return jsonify({"answer": response.text})
    except Exception:
        # Fallback to demo responses when API fails
        demo_answer = get_demo_response(user_question)
        return jsonify({"answer": demo_answer, "demo": True})


if __name__ == "__main__":
    # Load .env file manually
    env_path = os.path.join(os.path.dirname(__file__), ".env")
    if os.path.exists(env_path):
        with open(env_path) as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith("#") and "=" in line:
                    key, value = line.split("=", 1)
                    os.environ[key.strip()] = value.strip()
        genai.configure(api_key=os.environ.get("GEMINI_API_KEY", ""))

    app.run(debug=True, port=5000)
